= Virtual Private Cloud
:keywords: cloudhub, vpc, ipsec, ssl


image:cloudhub-logo.png[cloudhub]

The Virtual Private Cloud (VPC) offering allows you to virtually create a private and isolated network in the cloud to host your link:/runtime-manager/cloudhub-architecture#cloudhub-workers[CloudHub workers]. +
You can choose to use this isolated network as it best suites your needs.

* Host your applications in a VPC to take advantage of its link:/runtime-manager/cloudhub-load-balancer[load balancer features]
* Connect your VPC to your corporate intranet – whether on-premises or in other clouds – via a VPN connection as if they were all part of a single, private network.

== How VPC Works

As opposed to the default configuration, where all CloudHub workers reside in a link:/runtime-manager/cloudhub-architecture#global-worker-clouds[multi-tenant public cloud], the Virtual Private Cloud grants you a logically private and isolated network dedicated to host your CloudHub worker instances. +

All VPCs need to be associated to a CloudHub region and to an environment inside one of your CloudHub organization or business group. +
You can choose to mark a VPC as *default* for the region in which you created it, meaning that by default, all environments in this region that are not associated to a VPC, will be associated to the default VPC.

Each VPC can host one or many link:/runtime-manager/cloudhub-networking-guide#load-balancing[load balancers], and each load balancer has a CNAME record that hosts link:/runtime-manager/cloudhub-load-balancer#mapping[mapping lists] under the same SSL endpoint. +
Each SSL endpoint can also have link:https://en.wikipedia.org/wiki/Subject_Alternative_Name[Subject Alternative Names (SAN)] so the same certificate can be used across all matching rules. This allows you to host your CloudHub applications in a maintainable, secure, and scalable environment, that you can control and administrate.

You can also connect this network to other VPCs or other data centers via a secure VPN connection. This allows CloudHub workers to access resources behind your corporate firewall. You can leverage an *IPSec* gateway or *Amazon Web Services (AWS) _Direct Connect_* for VPN connectivity. +
Learn more about each connection alternative in the <<VPC Connectivity Methods>> section below.

== Configuring VPC for Your Account

In order to properly configure a VPC for your account, you need to keep a few considerations in mind.

Defining a proper sizing for your VPC at the beginning is crucial, since once a VPC is created you need to remove all your workers and redeploy them once the change is complete. In order to avoid unnecessary down time, it is recommended to design your VPC to scale accordingly.
It is important to define a proper IP address range to determine the <<Size Your VPC, size for your VPC>>.

As stated earlier, creating a VPC on its own is just the first step. In order for the VPC to be able to host your Workers, it needs to be bound to a business group and a specific CloudHub region. So understanding how <<VPC Entitlements, entitlements>> work is essential.

Once this is defined, you can proceed to create your VPC using the link:/anypoint-platform-for-apis/anypoint-platform-cli[Anypoint Platform CLI] (Look for the specific `vpc create` command).

If you need to connect other private networks to your CloudHub VPC, follow the steps described in the <<VPC Connectivity Methods, connectivity methods section>>.

=== Size Your VPC

When you create a VPC, the range of IP addresses for this network needs to be specified in the form of a Classless Inter-Domain Routing (CIDR) block, using link:https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks[CIDR notation].

In order to calculate the proper sizing for your VPC you need to understand that the amount of dedicated IP addresses is not the same as the amount of workers you have deployed. +
For each worker deployed to CloudHub, the following IP assignation takes place:

* For better fault tolerance the VPC subnet may be divided in up to 4 Availability Zones.
* A few IP addresses are reserved for infrastructure.
* At least two IP addresses per worker to perform at zero-downtime.

Due to this structure, the smallest network subnet block you can assign for your VPC is /24 and the largest /16. +
A /24 (link:https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks[CIDR notation]) subnet has 256 IP addresses. +
Reserving one IP address for the network and one for broadcast you have 254 hosts for your worker, which get divided into 4 availability zones of 62 hosts each. Consider that each worker potentially needs two IP addresses for zero-downtime, that's around 30 IP addresses to assign to your workers.

[NOTE]
--
Updating the size of a VPC once it's created and hosting workers demands for all applications to be undeployed before resizing. +
When planning a VPC size, keep in mind to leave a few spare IP addresses in case you need to host more workers.
--

The safe rule of thumb for deciding the size of your VPC subnet is `10 times the maximum number of expected apps to deploy in the VPC`. +

=== VPC Entitlements

As an organization administrator, you can create a VPC and assign it to any business group below your main organization, however once the VPC is assigned to a business group, only the administrator of this Business group can operate the VPC (i.e. set firewall rules, assign it as default to an environment within that business group).

VPCs can only be shared vertically and from the parent organization to one of its child. You cannot share a VPC created by a child business group to its parent business group.

=== VPC Connectivity Methods

If you need to connect your VPC to your internal network, or to another Cloud network, select the appropriate connectivity method for your use case. Then, contact your MuleSoft account representative to discuss your specific requirements. 
Once you have selected an option, download link:_attachments/VPC-Gateway-Questionnaire-v8.xlsm[the VPC discovery form] (requires at least MS Excel 2007 with macros enabled), then enter data to communicate the necessary details required for your connectivity method. Once they receive your form and answer any remaining questions, the CloudHub support team securely exchanges keys and supplies instructions on how to configure your router(s).

You can connect a Virtual Private Cloud to a datacenter using any of these methods:

. *Public Internet:* Default connectivity to CloudHub VPC.

. *IPsec tunnel with network-to-network configuration:* Connect a network to a CloudHub VPC with an link:http://en.wikipedia.org/wiki/IPsec[IPsec] VPN connection as shown in the diagram below: +
image:CHVPC02.png[CHVPC02]
[NOTE]
IPsec is, in general, the recommended solution for VPC to on-premise connectivity. It provides a standardized, secure way to connect, which integrates well with existing IT infrastructure such as routers/appliances.

. *VPC Peering:* Pair an Amazon VPC directly to a CloudHub VPC. +
If the services you are connecting to are hosted on AWS, then you can choose to peer your CloudHub VPC and your AWS VPC. +
Note that to leverage AWS Direct Connect you must be able to set up the direct connections within AWS.+
The diagram below illustrates connecting a CloudHub VPC and Amazon VPC together directly through VPC peering: +
image:CHVPC05.png[CHVPC05]

The SLA for configuring VPC is 5 business days after link:_attachments/VPC-Gateway-Questionnaire-v8.xlsm[the VPC discovery form] has been completed and returned, though it may be completed sooner.

== Frequently Asked Questions about CloudHub VPC

*Can I reuse my existing Amazon VPC?*

No, but we can set up your CloudHub VPC to communicate with your existing Amazon VPC.

*How does VPC work with Amazon regions?*

Our VPC solution supports different Amazon regions. During setup, you need to specify which Amazon region you want. If you need support for multiple regions, please submit one copy of the discovery form for each region in which you need support. 

*Can I have multiple VPCs?*

Yes, customers can purchase as many VPCs as required, with a minimum purchase of two.  For more information on VPC pricing, contact your MuleSoft Account Executive.

*Can I have multiple VPCs in a single Amazon region?*

Yes, this is possible, but not included in our standard setup. Contact your account representative to discuss your requirements.

*How do I limit communication with my workers to my VPC channel?*

If you have VPC and you don't want your application exposed via the publicly accessible load balancer at `myapp.cloudhub.io`, you need to use 8091 or 8092 instead of `${http.port}` or `${https.port}`, respectively, when deploying your application.

*How do I communicate with my workers through my VPC without going over the public Internet?*

You can communicate with your Mule worker by using mule-worker-internal-myapp.cloudhub.io as the address in your configuration. This is a DNS A record which includes the IP addresses of all your workers.

== See Also

* For more options that provide scalability, workload distribution, zero message loss, and added reliability to CloudHub applications, see link:/runtime-manager/cloudhub-fabric[CloudHub Fabric].
